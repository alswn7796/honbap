<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ํผ๋ฐฅ๋ฌ ยท ๋ก๊ทธ์ธ</title>
    <link rel="stylesheet" href="style.css" />
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">๐</div>
            <h1 class="title">ํผ๋ฐฅ๋ฌ ยท ๋ก๊ทธ์ธ</h1>
        </div>

        <div class="card" style="max-width:560px">
            <label>์ด๋ฉ์ผ</label>
            <input id="email" type="email" placeholder="school@kw.ac.kr" autocomplete="username" />

            <label>๋น๋ฐ๋ฒํธ</label>
            <input id="pw" type="password" placeholder="********" autocomplete="current-password" />

            <button id="loginBtn" class="btn" type="button">๋ก๊ทธ์ธ</button>
            <button id="resetBtn" class="btn secondary" type="button" style="margin-top:8px">๋น๋ฐ๋ฒํธ ์ฌ์ค์ ๋ฉ์ผ ๋ณด๋ด๊ธฐ</button>

            <p id="msg" class="status" style="min-height:22px"></p>
            <p id="errraw" class="status" style="min-height:18px;color:#9aa0a6;font-size:12px"></p>

            <div class="row" style="gap:12px;margin-top:8px">
                <a class="link-btn" href="signup.html">ํ์๊ฐ์</a>
                <a class="link-btn" href="community.html">์ปค๋ฎค๋ํฐ</a>
                <a class="link-btn" href="index.html">ํ</a>
            </div>
        </div>
    </div>

    <script type="module" src="firebase.js?v=login-dbg"></script>
    <script type="module">
        const $ = (s) => document.querySelector(s);
        const emailEl = $("#email");
        const pwEl = $("#pw");
        const btn = $("#loginBtn");
        const reset = $("#resetBtn");
        const msg = $("#msg");
        const raw = $("#errraw");

        function setMsg(kind, text, rawText = "") {
            msg.className = "status " + (kind || "");
            msg.textContent = text || "";
            raw.textContent = rawText || "";
        }

        [emailEl, pwEl].forEach(el => {
            el.addEventListener("keydown", (e) => { if (e.key === "Enter") btn.click(); });
        });

        btn.addEventListener("click", async () => {
            try {
                setMsg("", "");
                btn.disabled = true; reset.disabled = true;
                await window.fbReady;

                const email = emailEl.value.trim();
                const pw = pwEl.value;
                if (!email || !pw) { setMsg("err", "์ด๋ฉ์ผ๊ณผ ๋น๋ฐ๋ฒํธ๋ฅผ ์๋ฅํ์ธ์."); return; }

                await window.fb.loginWithEmailPassword(email, pw);
                setMsg("ok", "๋ก๊ทธ์ธ ์ฑ๊ณต! ์ด๋ํฉ๋๋คโฆ");
                location.href = "index.html";
            } catch (e) {
                const code = e?.code || "";
                const message = e?.message || String(e);
                let pretty = "๋ก๊ทธ์ธ ์คํจ";
                if (code.includes("invalid-credential")) pretty = "๊ณ์์ ๋น๋ฐ๋ฒํธ๊ฐ ์๊ฑฐ๋(์ด๋ฉ์ผ ๋งํฌ ๊ฐ์), ๋น๋ฐ๋ฒํธ๊ฐ ์ฌ๋ฐ๋ฅด์ง ์์ต๋๋ค.";
                else if (code.includes("wrong-password")) pretty = "๋น๋ฐ๋ฒํธ๊ฐ ์ฌ๋ฐ๋ฅด์ง ์์ต๋๋ค.";
                else if (code.includes("user-not-found")) pretty = "๊ฐ์๋ ๊ณ์์ ์ฐพ์ ์ ์์ต๋๋ค.";
                else if (code.includes("too-many-requests")) pretty = "์๋ ํ์๊ฐ ๋ง์ต๋๋ค. ์์ ํ ๋ค์ ์๋ํ์ธ์.";
                else if (code.includes("network-request-failed")) pretty = "๋คํธ์ํฌ ์ค๋ฅ์๋๋ค. ์ฐ๊ฒฐ์ ํ์ธํ์ธ์.";
                setMsg("err", pretty, `[${code}] ${message}`);
            } finally {
                btn.disabled = false; reset.disabled = false;
            }
        });

        reset.addEventListener("click", async () => {
            try {
                setMsg("", "");
                reset.disabled = true; btn.disabled = true;
                await window.fbReady;
                const email = emailEl.value.trim();
                await window.fb.resetPasswordByEmail(email);
                setMsg("ok", "์ฌ์ค์ ๋ฉ์ผ์ ๋ณด๋์ต๋๋ค. ๋ฉ์ผํจ์ ํ์ธํ์ธ์.");
            } catch (e) {
                setMsg("err", "์ฌ์ค์ ๋ฉ์ผ ๋ฐ์ก ์คํจ", `[${e?.code}] ${e?.message || e}`);
            } finally {
                reset.disabled = false; btn.disabled = false;
            }
        });

        // ์ด๋ฏธ ๋ก๊ทธ์ธ๋์ด ์์ผ๋ฉด ํ์ผ๋ก
        (async () => {
            try {
                await window.fbReady;
                window.fb.requireAuth().then(() => location.replace("index.html")).catch(() => { });
            } catch (_) { }
        })();
    </script>
</body>
</html>
