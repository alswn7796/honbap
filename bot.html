<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>í˜¼ë°¥ëŸ¬ Â· í…ŒìŠ¤íŠ¸ ë´‡</title>
    <link rel="stylesheet" href="style.css?v=36" />
</head>
<body>
    <div class="container">
        <div class="header"><div class="logo">ğŸ¤–</div><h1 class="title">í˜¼ë°¥ëŸ¬ Â· í…ŒìŠ¤íŠ¸ ë´‡</h1></div>
        <div class="card">
            <p class="muted">ì´ í”„ë ˆì„ì€ ë´‡ ì „ìš© ì•±ìœ¼ë¡œ ìµëª… ë¡œê·¸ì¸í•˜ì—¬ ëŒ€ê¸°ì—´ì— ë“¤ì–´ê°‘ë‹ˆë‹¤.</p>
            <p id="log" class="status"></p>
            <div class="nav">
                <a class="link-btn" href="#" onclick="location.reload();return false;">ìƒˆë¡œê³ ì¹¨</a>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getAuth, setPersistence, browserSessionPersistence, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
        import {
            getFirestore, doc, setDoc, updateDoc, deleteDoc, serverTimestamp,
            collection, query, where, limit, getDocs
        } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

        const logEl = document.getElementById("log");
        const log = (t, ok = false) => { logEl.className = "status " + (ok ? "ok" : ""); logEl.textContent = t; };

        // ë™ì¼ í”„ë¡œì íŠ¸ì§€ë§Œ "bot"ì´ë¼ëŠ” ë³„ë„ ì•± ì´ë¦„ìœ¼ë¡œ ë…ë¦½ ì¸ìŠ¤í„´ìŠ¤ ìƒì„± -> ë©”ì¸ ì¸ì¦ê³¼ ë¶„ë¦¬ë¨
        const firebaseConfig = {
            apiKey: "AIzaSyB0TUXQpzZIy0v2gbLOC343Jx_Lv51EQvw",
            authDomain: "honbap-paring.firebaseapp.com",
            projectId: "honbap-paring",
            storageBucket: "honbap-paring.firebasestorage.app",
            messagingSenderId: "375771626039",
            appId: "1:375771626039:web:03868631de56225cf49db2",
        };
        const botApp = initializeApp(firebaseConfig, "bot");
        const auth = getAuth(botApp);
        const db = getFirestore(botApp);

        const HEARTBEAT_MS = 10_000;
        let hb = null;

        async function enqueue() {
            const u = auth.currentUser;
            const ref = doc(db, "matchQueue", u.uid);
            const now = serverTimestamp();
            await setDoc(ref, {
                uid: u.uid, email: null,
                pref: { bot: true }, status: "waiting",
                lastActive: now, createdAt: now, roomId: null,
            }, { merge: true });

            if (hb) clearInterval(hb);
            hb = setInterval(async () => { try { await updateDoc(ref, { lastActive: serverTimestamp() }); } catch (_) { } }, HEARTBEAT_MS);
            log("ë´‡ ì¤€ë¹„ ì™„ë£Œ. ëŒ€ê¸°ì—´ì— ë“±ë¡í•¨â€¦", true);
        }

        async function cleanup() {
            try {
                const u = auth.currentUser;
                if (!u) return;
                if (hb) { clearInterval(hb); hb = null; }
                await deleteDoc(doc(db, "matchQueue", u.uid)).catch(() => { });
            } catch (_) { }
        }

        // ìë™ ì‹œì‘
        await setPersistence(auth, browserSessionPersistence);
        await new Promise((resolve, reject) => {
            onAuthStateChanged(auth, async (user) => {
                try {
                    if (!user) { await signInAnonymously(auth); return; }
                    // ë¡œê·¸ì¸ë˜ë©´ ë°”ë¡œ ëŒ€ê¸°ì—´ ì§„ì…
                    await enqueue();
                    resolve();
                } catch (e) { reject(e); }
            }, reject);
        });

        window.addEventListener("beforeunload", cleanup);
    </script>
</body>
</html>
