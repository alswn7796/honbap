<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>혼밥러 · 프로필</title>
    <link rel="stylesheet" href="style.css" />
    <script type="module" src="./firebase.js?v=27"></script>
</head>
<body>
    <button id="logoutFab" class="btn outline">로그아웃</button>

    <div class="container">
        <header class="page-header"><h1 class="title">🍱 혼밥러 · 프로필</h1></header>

        <div class="card">
            <p class="muted">로그인 이메일: <span id="loginEmail"></span></p>

            <label class="label">학번(입학년도)</label>
            <input id="year" class="input" type="text" placeholder="예: 22" />
            <label class="label">나이(만)</label>
            <input id="age" class="input" type="text" placeholder="예: 만 나이 입력" />
            <label class="label">성별</label>
            <select id="gender" class="input">
                <option value="">선택</option>
                <option value="남">남</option>
                <option value="여">여</option>
            </select>
            <label class="label">학과</label>
            <input id="major" class="input" type="text" placeholder="예: 소프트웨어학부" />
            <label class="label">MBTI</label>
            <input id="mbti" class="input" type="text" placeholder="예: ISTP" />
            <label class="label">혼밥 때 주요 소비 콘텐츠</label>
            <input id="content" class="input" type="text" placeholder="예: 유튜브, 음악" />
            <label class="label">공강시간(문장형 입력)</label>
            <input id="freeText" class="input" type="text" placeholder="예: 월 12-15, 화 3-4" />

            <button id="saveBtn" class="btn primary" style="margin-top:16px">프로필 저장</button>
            <p id="status" class="status muted" style="margin-top:8px;"></p>
        </div>

        <div class="row between" style="margin-top:16px; transform: translateY(-0.7cm);">
            <a class="btn outline" href="community.html" style="width:auto !important; display:inline-flex !important; padding:6px 12px; font-size:14px;">커뮤니티</a>
            <a class="btn outline" href="index.html" style="width:auto !important; display:inline-flex !important; padding:6px 12px; font-size:14px;">홈</a>
        </div>
    </div>

    <script type="module">
        const fbReady = window.fbReady || Promise.resolve(window.fb);
        const $ = (id) => document.getElementById(id);

        const year = $('year'), age = $('age'), gender = $('gender'), major = $('major');
        const mbti = $('mbti'), content = $('content'), freeText = $('freeText');
        const loginEmail = $('loginEmail'), statusEl = $('status'), saveBtn = $('saveBtn');
        const setStatus = (msg, kind = '') => { statusEl.textContent = msg || ''; statusEl.className = 'status ' + (kind || ''); };

        async function boot() {
            const fb = await fbReady;
            try { const u = await fb.requireAuth(); loginEmail.textContent = u?.email ?? '(익명)'; }
            catch { loginEmail.textContent = ''; }

            try {
                const data = await fb.loadProfile().catch(() => null);
                if (data) {
                    if (data.year != null) year.value = data.year;
                    if (data.age != null) age.value = data.age;
                    if (data.gender) gender.value = data.gender;
                    if (data.major) major.value = data.major;
                    if (data.mbti) mbti.value = data.mbti;
                    if (data.content) content.value = data.content;
                    if (typeof data.freeText === 'string') freeText.value = data.freeText;
                }
            } catch { setStatus('프로필을 불러오지 못했어요.', 'err'); }

            saveBtn.addEventListener('click', async () => {
                setStatus('저장 중…'); saveBtn.disabled = true;
                const payload = {
                    year: year.value, age: age.value, gender: gender.value,
                    major: major.value, mbti: mbti.value, content: content.value, freeText: freeText.value
                };
                try {
                    const res = await (await fbReady).saveProfile(payload);
                    if (res?.ok) setStatus('프로필 저장 완료!', 'ok');
                    else setStatus('저장 결과를 확인하지 못했어요.', 'err');
                } catch (e) {
                    setStatus('저장 실패: ' + (e?.message || e), 'err');
                    console.error('[profile save error]', e);
                } finally { saveBtn.disabled = false; }
            });

            $('logoutFab').addEventListener('click', async () => {
                try { await (await fbReady).logout(); } catch { }
                location.href = 'login.html';
            });
        }
        boot();
    </script>
</body>
</html>
