<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>혼밥러 · 홈</title>
    <link rel="stylesheet" href="style.css?v=20" />
    <style>
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3,1fr);
            gap: 12px
        }

        .tile {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px;
            border-radius: 14px;
            background: #0e1322;
            border: 1px solid #22283a;
            cursor: pointer;
            text-align: center;
            min-height: 86px
        }

            .tile .emoji {
                font-size: 22px
            }

        .section-title {
            font-size: 18px;
            margin: 0 0 10px 0
        }

        .muted-sm {
            color: #9aa0a6;
            font-size: 12px
        }

        .post-card {
            background: #0e1322;
            border: 1px solid #22283a;
            border-radius: 12px;
            padding: 12px;
            margin-top: 10px
        }

        .post-title {
            font-weight: 800;
            font-size: 15px;
            margin: 0 0 4px 0
        }

        .post-meta {
            color: #9aa0a6;
            font-size: 12px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap
        }

        .row-wrap {
            display: flex;
            gap: 8px;
            flex-wrap: wrap
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header" style="margin-bottom:12px">
            <div class="logo">🏫</div>
            <h1 class="title">혼밥러 · 홈</h1>
        </div>

        <div class="card">
            <div class="grid-3">
                <a class="tile" href="match.html"><div class="emoji">🍚</div><div><b>혼밥러 매칭</b><div class="muted-sm">바로 시작</div></div></a>
                <a class="tile" href="community.html"><div class="emoji">🗨️</div><div><b>커뮤니티</b><div class="muted-sm">글/댓글/좋아요</div></div></a>
                <a class="tile" href="profile.html"><div class="emoji">👤</div><div><b>내 프로필</b><div class="muted-sm">정보 수정</div></div></a>
            </div>
        </div>

        <div class="card" style="margin-top:16px">
            <h2 class="section-title">무슨 생각 중이에요?</h2>
            <div class="row"><input id="quickTitle" type="text" placeholder="제목 (예: 오늘 점심 추천)" maxlength="120" /></div>
            <div class="row" style="margin-top:8px">
                <input id="quickBody" type="text" placeholder="내용 한 줄 (커뮤니티에 올라가요)" />
                <button id="quickPostBtn" class="btn" style="width:auto;min-width:120px">등록</button>
            </div>
            <p id="quickMsg" class="status"></p>
            <div class="muted-sm">전체 글쓰기는 <a href="community.html">커뮤니티</a>에서 할 수 있어요.</div>
        </div>

        <div class="card" style="margin-top:16px">
            <div class="topbar" style="margin-bottom:0">
                <h2 class="section-title" style="margin:0">최신 글</h2>
                <a class="link-btn" href="community.html">더 보기</a>
            </div>
            <div id="feed"></div>
        </div>

        <div class="card" style="margin-top:16px">
            <h2 class="section-title">내 프로필</h2>
            <div id="profileBox" class="muted-sm">불러오는 중...</div>
            <div class="nav" style="margin-top:12px">
                <a class="link-btn" href="profile.html">프로필 수정</a>
            </div>
        </div>
    </div>

    <script type="module" src="./firebase.js?v=27"></script>
    <script type="module">
        const $ = (s) => document.querySelector(s);
        const feed = $("#feed"), quickTitle = $("#quickTitle"), quickBody = $("#quickBody");
        const quickBtn = $("#quickPostBtn"), quickMsg = $("#quickMsg"), profileBox = $("#profileBox");

        if (window.fbReady) await window.fbReady;
        try { await window.fb.requireAuth(); } catch (e) { location.href = "signup.html"; throw e; }

        quickBtn.addEventListener("click", async () => {
            try {
                quickMsg.className = "status"; quickMsg.textContent = "";
                const title = (quickTitle.value || "").trim();
                const body = (quickBody.value || "").trim();
                if (!title) { quickMsg.className = "status err"; quickMsg.textContent = "제목을 입력하세요."; return; }
                quickBtn.disabled = true;
                await window.fb.createPost({ title, body });
                quickTitle.value = ""; quickBody.value = "";
                quickMsg.className = "status ok"; quickMsg.textContent = "등록 완료! 커뮤니티에 반영되었어요.";
                feed.innerHTML = ""; await loadFeed();
            } catch (e) { quickMsg.className = "status err"; quickMsg.textContent = e.message || e; }
            finally { quickBtn.disabled = false; }
        });

        const esc = (s) => (s || "").replace(/[&<>"']/g, m => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#39;" }[m]));
        async function loadFeed() {
            const { items } = await window.fb.listPosts({ pageSize: 5 });
            items.forEach(p => {
                const card = document.createElement("div");
                card.className = "post-card";
                card.innerHTML = `
              <div class="post-title">${esc(p.title)}</div>
              <div class="post-meta">
                <span>${p.authorEmail ? esc(p.authorEmail.split("@")[0]) : "익명"}</span>
                <span>·</span>
                <span>${p.createdAt?.toDate ? p.createdAt.toDate().toLocaleString() : ""}</span>
              </div>
              <div class="muted-sm" style="margin-top:6px">${esc((p.body || "").slice(0, 100))}${(p.body || "").length > 100 ? "…" : ""}</div>
              <div class="nav" style="margin-top:10px">
                <a class="link-btn" href="community.html">댓글/상세 보기</a>
              </div>
            `;
                feed.appendChild(card);
            });
            if (items.length === 0) {
                const div = document.createElement("div"); div.className = "muted-sm"; div.style.marginTop = "6px";
                div.textContent = "아직 글이 없어요. 첫 글을 남겨보세요!";
                feed.appendChild(div);
            }
        }
        await loadFeed();

        try {
            const data = await window.fb.loadProfile().catch(() => null);
            const lines = [];
            if (data?.major) lines.push(`학과: ${data.major}`);
            if (data?.year != null) lines.push(`학번: ${data.year}`);
            if (data?.age != null) lines.push(`나이: ${data.age}`);
            if (data?.gender) lines.push(`성별: ${data.gender}`);
            if (data?.mbti) lines.push(`MBTI: ${data.mbti}`);
            if (data?.content) lines.push(`혼밥 콘텐츠: ${data.content}`);
            profileBox.textContent = lines.length ? lines.join(" · ") : "아직 프로필 정보가 비어 있어요.";
        } catch { profileBox.textContent = "프로필을 불러오지 못했어요."; }
    </script>
</body>
</html>
