<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>혼밥러 · 커뮤니티</title>
    <link rel="stylesheet" href="style.css?v=20" />
    <style>
        .post-card {
            background: #0e1322;
            border: 1px solid #22283a;
            border-radius: 12px;
            padding: 14px;
            margin-top: 12px
        }

        .post-title {
            font-weight: 800;
            font-size: 16px;
            margin: 0 0 4px 0
        }

        .post-meta {
            font-size: 12px;
            color: #9aa0a6;
            margin: 4px 0 8px 0
        }

        .post-body {
            white-space: pre-wrap;
            line-height: 1.5
        }

        .row-wrap {
            display: flex;
            gap: 8px;
            flex-wrap: wrap
        }

        .muted-sm {
            color: #9aa0a6;
            font-size: 12px
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="topbar">
            <div class="header" style="margin:0">
                <div class="logo">🧑‍🍳</div>
                <h1 class="title">혼밥러 · 커뮤니티</h1>
            </div>
            <div class="row-wrap">
                <a class="link-btn" href="match.html">매칭</a>
                <a class="link-btn" href="profile.html">프로필</a>
                <a class="link-btn" href="index.html">홈</a>
            </div>
        </div>

        <div class="card">
            <h2 class="title" style="font-size:18px;margin-top:0">게시글 쓰기</h2>
            <label>제목</label>
            <input id="title" type="text" placeholder="예: 오늘 점심 혼밥 후기" maxlength="120" />
            <label>내용</label>
            <textarea id="body" rows="6" placeholder="예: 추천 식당/메뉴/시간대 등 자유롭게"></textarea>
            <div class="row" style="margin-top:8px">
                <button id="postBtn" class="btn" style="width:auto;min-width:120px">등록</button>
                <span id="postMsg" class="status"></span>
            </div>
        </div>

        <div class="card" style="margin-top:16px">
            <div class="topbar" style="margin-bottom:0">
                <h2 class="title" style="font-size:18px;margin:0">최신 글</h2>
                <span class="muted-sm" id="countTxt"></span>
            </div>
            <div id="list"></div>
            <button id="moreBtn" class="btn secondary" style="margin-top:12px;display:none">더 보기</button>
        </div>
    </div>

    <script type="module" src="./firebase.js?v=27"></script>
    <script type="module">
        const $ = (s) => document.querySelector(s);
        const list = $("#list"), moreBtn = $("#moreBtn"), countTxt = $("#countTxt");
        const postBtn = $("#postBtn"), postMsg = $("#postMsg");
        let cursor = null;

        if (window.fbReady) await window.fbReady;
        try { await window.fb.requireAuth(); } catch (e) {
            alert("로그인이 필요합니다."); location.href = "login.html"; throw e;
        }

        postBtn.addEventListener("click", async () => {
            try {
                postMsg.className = "status"; postMsg.textContent = "";
                const title = $("#title").value.trim();
                const body = $("#body").value.trim();
                if (!title) throw new Error("제목을 입력하세요.");
                postBtn.disabled = true;
                await window.fb.createPost({ title, body });
                $("#title").value = ""; $("#body").value = "";
                postMsg.className = "status ok"; postMsg.textContent = "등록 완료!";
                list.innerHTML = ""; cursor = null; await loadMore();
            } catch (e) {
                postMsg.className = "status err"; postMsg.textContent = e.message || e;
            } finally { postBtn.disabled = false; }
        });

        async function loadMore() {
            const { items, cursor: next } = await window.fb.listPosts({ pageSize: 10, cursor });
            items.forEach(renderPostCard);
            cursor = next;
            moreBtn.style.display = cursor ? "inline-block" : "none";
            countTxt.textContent = "";
        }
        moreBtn.addEventListener("click", loadMore);

        const esc = (s) => (s || "").replace(/[&<>"']/g, m => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#39;" }[m]));
        function renderPostCard(p) {
            const wrap = document.createElement("div");
            wrap.className = "post-card";
            wrap.innerHTML = `
            <h3 class="post-title">${esc(p.title)}</h3>
            <div class="post-meta">${p.authorEmail ? esc(p.authorEmail.split("@")[0]) : "익명"} · ${p.createdAt?.toDate ? p.createdAt.toDate().toLocaleString() : ""}</div>
            <div class="post-body">${esc(p.body)}</div>
          `;
            list.prepend(wrap);
        }

        await loadMore();
    </script>
</body>
</html>
