<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>í˜¼ë°¥ëŸ¬ Â· ì»¤ë®¤ë‹ˆí‹°</title>
    <link rel="stylesheet" href="style.css?v=31" />
</head>
<body>
    <div class="container">
        <div class="topbar">
            <div class="header" style="margin:0">
                <div class="logo">ğŸš</div>
                <h1 class="title">í˜¼ë°¥ëŸ¬ Â· ì»¤ë®¤ë‹ˆí‹°</h1>
            </div>
            <div>
                <a class="link-btn" href="match.html">ë§¤ì¹­</a>
                <a class="link-btn" href="profile.html">í”„ë¡œí•„</a>
                <a class="link-btn" href="index.html">í™ˆ</a>
            </div>
        </div>

        <div class="card">
            <h3 style="margin:0 0 10px">ê²Œì‹œê¸€ ì“°ê¸°</h3>
            <label>ì œëª©</label>
            <input id="title" type="text" placeholder="ì˜ˆ: ì˜¤ëŠ˜ ì ì‹¬ í˜¼ë°¥ í›„ê¸°" />
            <label>ë‚´ìš©</label>
            <textarea id="body" rows="4" placeholder="ììœ ë¡­ê²Œ ì‘ì„±í•˜ì„¸ìš”."></textarea>
            <button id="postBtn" class="btn" style="width:auto;min-width:90px">ë“±ë¡</button>
            <p id="msg" class="status"></p>
        </div>

        <div class="card">
            <div class="topbar" style="margin:0 0 6px">
                <h3 class="title" style="font-size:18px;margin:0">ìµœì‹  ê¸€</h3>
            </div>
            <div id="list"></div>
        </div>
    </div>

    <script type="module" src="./firebase.js?v=31"></script>
    <script type="module">
        const $ = (s) => document.querySelector(s);
        const msg = $("#msg");
        const setMsg = (t, ok = false) => { msg.className = "status " + (ok ? "ok" : "err"); msg.textContent = t; };

        if (window.fbReady) await window.fbReady;

        // ê¸€ ë“±ë¡
        $("#postBtn").addEventListener("click", async () => {
            try {
                msg.className = "status"; msg.textContent = "";
                // â¬‡ ë°˜ë“œì‹œ .valueë¡œ ë¬¸ìì—´ì„ ë„˜ê¸´ë‹¤
                const title = String($("#title").value ?? "");
                const body = String($("#body").value ?? "");
                await window.fb.createPost(title, body);
                setMsg("ë“±ë¡ ì™„ë£Œ!", true);
                $("#title").value = ""; $("#body").value = "";
                await render();
            } catch (e) {
                setMsg((e && e.message) ? e.message : String(e));
            }
        });

        // ëª©ë¡
        async function render() {
            try {
                const arr = await window.fb.listPosts({ limitCount: 50 });
                const box = $("#list");
                box.innerHTML = arr.map(p => {
                    const when = p.createdAt?.toDate?.() ? p.createdAt.toDate().toLocaleString() : "";
                    const title = (p.title || "").replace(/</g, "&lt;");
                    const body = (p.body || "").replace(/</g, "&lt;");
                    // ê´€ë¦¬ìë©´ ê·œì¹™ í†µê³¼ë¡œ ì‚­ì œ ê°€ëŠ¥(ë²„íŠ¼ì€ ëª¨ë‘ ë³´ì´ë˜, ê¶Œí•œ ì—†ìœ¼ë©´ permission ì—ëŸ¬)
                    return `<div style="padding:10px;border:1px solid #22283a;border-radius:10px;margin:8px 0;background:#0e1322">
                        <div style="display:flex;justify-content:space-between;gap:8px;align-items:center">
                          <div style="font-weight:700">${title}</div>
                          <button class="link-btn" data-del="${p.id}" style="background:#2a3145">ì‚­ì œ</button>
                        </div>
                        <div class="muted" style="font-size:12px">${when}</div>
                        <div style="margin-top:6px">${body}</div>
                      </div>`;
                }).join("") || `<p class="muted">ì•„ì§ ê¸€ì´ ì—†ì–´ìš”.</p>`;

                // ì‚­ì œ í•¸ë“¤ëŸ¬ ìœ„ì„
                box.querySelectorAll("[data-del]").forEach(btn => {
                    btn.addEventListener("click", async () => {
                        try {
                            await window.fb.deletePost(btn.dataset.del);
                            await render();
                        } catch (e) {
                            alert((e && e.message) ? e.message : String(e));
                        }
                    });
                });
            } catch (e) {
                console.error(e);
            }
        }
        render();
    </script>
</body>
</html>
