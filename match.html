<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>í˜¼ë°¥ëŸ¬ Â· ë§¤ì¹­</title>
    <link rel="stylesheet" href="style.css?v=40" />
    <style>
        .grid {
            display: grid;
            grid-template-columns: repeat(2,1fr);
            gap: 10px;
        }

        .pill {
            display: inline-block;
            padding: 6px 10px;
            border: 1px solid #2a3145;
            border-radius: 999px;
            font-size: 12px;
        }

        .section {
            margin-top: 14px;
            padding: 12px;
            border: 1px solid #22283a;
            border-radius: 12px;
            background: #0e1322;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header"><div class="logo">ğŸš</div><h1 class="title">í˜¼ë°¥ëŸ¬ Â· ë§¤ì¹­</h1></div>

        <div class="card">
            <div class="section">
                <h3 style="margin:0 0 8px 0;font-size:16px">í•„í„° ì„ íƒ(ì˜µì…˜)</h3>
                <div class="grid">
                    <div>
                        <label>í•™ë²ˆ(ì…í•™ë…„ë„)</label>
                        <input id="fYear" type="number" placeholder="ì˜ˆ: 23" />
                    </div>
                    <div>
                        <label>í•™ê³¼</label>
                        <input id="fMajor" type="text" placeholder="ì˜ˆ: ì†Œí”„íŠ¸ì›¨ì–´í•™ë¶€" />
                    </div>
                    <div>
                        <label>ì„±ë³„</label>
                        <select id="fGender">
                            <option value="">ìƒê´€ì—†ìŒ</option>
                            <option value="ë‚¨">ë‚¨</option>
                            <option value="ì—¬">ì—¬</option>
                            <option value="ê¸°íƒ€/ì‘ë‹µì•ˆí•¨">ê¸°íƒ€/ì‘ë‹µì•ˆí•¨</option>
                        </select>
                    </div>
                    <div class="grid" style="grid-template-columns:repeat(2,1fr); gap:8px">
                        <div>
                            <label>ë‚˜ì´ ìµœì†Œ</label>
                            <input id="fAgeMin" type="number" placeholder="ì˜ˆ: 20" />
                        </div>
                        <div>
                            <label>ë‚˜ì´ ìµœëŒ€</label>
                            <input id="fAgeMax" type="number" placeholder="ì˜ˆ: 30" />
                        </div>
                    </div>
                </div>
                <p class="muted" style="margin-top:8px">
                    * ê³µê°•ì‹œê°„ì€ í”„ë¡œí•„ì—ì„œ ì…ë ¥í•œ ê°’ì´ ì‚¬ìš©ë©ë‹ˆë‹¤. ì„œë¡œ ê³µê°•ì´ ê²¹ì³ì•¼ í›„ë³´ë¡œ ê°„ì£¼ë©ë‹ˆë‹¤.
                </p>
                <div class="row" style="margin-top:8px">
                    <button id="startBtn" class="btn">í˜¼ë°¥ëŸ¬ ì°¾ê¸°(ìš”ì²­)</button>
                    <button id="startBotBtn" class="btn" style="width:auto;min-width:220px">í˜¼ë°¥ëŸ¬ ì°¾ê¸°(ë´‡ í…ŒìŠ¤íŠ¸ Â· ê°™ì€ íƒ­)</button>
                    <button id="cancelBtn" class="btn" style="width:auto;min-width:120px;background:#0e1322;border:1px solid #22283a;color:#e9eef5" disabled>ë‚˜ê°€ê¸°</button>
                </div>
            </div>

            <div class="section">
                <h3 style="margin:0 0 8px 0;font-size:16px">ì§„í–‰ ìƒíƒœ</h3>
                <p id="status" class="status"></p>
                <!-- ìƒëŒ€ì—ê²Œì„œ ì˜¨ 'ì œì•ˆ' / ë‚´ê°€ ê±´ 'ì œì•ˆ' / ì±„íŒ… ì‹œì‘(Y/N) -->
                <div id="incoming" style="display:none">
                    <div class="pill">ìƒëŒ€ê°€ ë§¤ì¹­ì„ ì œì•ˆí–ˆìŠµë‹ˆë‹¤.</div>
                    <p id="incomingInfo" class="muted"></p>
                    <div class="row"><button id="acceptBtn" class="btn">ìˆ˜ë½</button><button id="declineBtn" class="btn" style="background:#0e1322;border:1px solid #22283a;color:#e9eef5">ê±°ì ˆ</button></div>
                </div>

                <div id="readyYN" style="display:none; margin-top:8px">
                    <div class="pill">ë§¤ì¹­ ìˆ˜ë½ ì™„ë£Œ. ì±„íŒ…ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</div>
                    <div class="row"><button id="readyYes" class="btn">Y</button><button id="readyNo" class="btn" style="background:#0e1322;border:1px solid #22283a;color:#e9eef5">N</button></div>
                </div>
            </div>

            <div class="hr"></div>
            <div class="nav">
                <a class="link-btn" href="community.html">ì»¤ë®¤ë‹ˆí‹°</a>
                <a class="link-btn" href="profile.html">í”„ë¡œí•„</a>
                <a class="link-btn" href="index.html">í™ˆ</a>
            </div>
        </div>
    </div>

    <!-- ë´‡ í”„ë ˆì„(ê°™ì€ íƒ­ í…ŒìŠ¤íŠ¸ìš©) -->
    <iframe id="botFrame" src="about:blank" style="width:0;height:0;border:0;position:absolute;left:-9999px;top:-9999px"></iframe>

    <script type="module" src="./firebase.js?v=40"></script>
    <script type="module">
        const $ = (s) => document.querySelector(s);
        const statusEl = $("#status");
        const startBtn = $("#startBtn"), startBotBtn = $("#startBotBtn"), cancelBtn = $("#cancelBtn");
        const incoming = $("#incoming"), incomingInfo = $("#incomingInfo");
        const acceptBtn = $("#acceptBtn"), declineBtn = $("#declineBtn");
        const readyYN = $("#readyYN"), yesBtn = $("#readyYes"), noBtn = $("#readyNo");
        const botFrame = $("#botFrame");

        const setStatus = (t, cls = "") => { statusEl.className = "status " + cls; statusEl.textContent = t; };

        if (window.fbReady) await window.fbReady;
        try { await window.fb.requireAuth(); } catch (e) { setStatus("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.", "err"); setTimeout(() => location.href = "login.html", 700); throw e; }

        let currentPairId = null;
        let unsubPairs = null, unsubIncoming = null;

        // ë‚´ pairings ìƒíƒœ ê°ì‹œ â†’ ë‹¨ê³„ë³„ UI ê°±ì‹ 
        function subscribePairings() {
            if (unsubPairs) unsubPairs();
            unsubPairs = window.fb.watchMyPairings(async (list) => {
                // ê°€ì¥ ìµœê·¼ í•­ëª© í•˜ë‚˜ ê¸°ì¤€
                list.sort((a, b) => (b.updatedAt?.seconds || 0) - (a.updatedAt?.seconds || 0));
                const p = list[0];
                if (!p) { currentPairId = null; readyYN.style.display = "none"; return; }
                currentPairId = p.pairId || p.id;

                if (p.status === "accepted") {
                    readyYN.style.display = "block";
                    setStatus("ë§¤ì¹­ ìˆ˜ë½ë¨. ì±„íŒ… ì‹œì‘(Y/N)ì„ ì„ íƒí•˜ì„¸ìš”.", "ok");
                } else if (p.status === "chatting" && p.roomId) {
                    setStatus("ì±„íŒ…ë°©ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤â€¦", "ok");
                    location.href = `chat.html?room=${encodeURIComponent(p.roomId)}`;
                } else if (p.status === "proposed") {
                    // ë‚´ê°€ ë‚¸ ì œì•ˆì¼ ìˆ˜ ìˆìŒ
                    readyYN.style.display = "none";
                    setStatus("ìƒëŒ€ ì‘ë‹µ ëŒ€ê¸° ì¤‘â€¦");
                } else if (p.status === "cancelled") {
                    readyYN.style.display = "none";
                    setStatus("ë§¤ì¹­ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.", "err");
                }
            });
        }

        // ìƒëŒ€ì—ê²Œì„œ ì˜¨ proposal ê°ì‹œ
        function subscribeIncoming() {
            if (unsubIncoming) unsubIncoming();
            unsubIncoming = window.fb.onIncomingProposals((list) => {
                if (list.length === 0) { incoming.style.display = "none"; return; }
                const p = list[0]; // ê°€ì¥ ìµœê·¼ í•˜ë‚˜ë§Œ
                currentPairId = p.pairId || p.id;
                incoming.style.display = "block";
                incomingInfo.textContent = `ê³µê°• ê²¹ì¹¨: ${p.overlapSlot || "ë¯¸ìƒ"}, í•„í„°: ${Object.keys(p.filters || {}).map(k => `${k}=${p.filters[k]}`).join(", ") || "ì—†ìŒ"}`;
                setStatus("í˜¼ë°¥ëŸ¬ ë§¤ì¹­ ì œì•ˆ ë„ì°©: ìˆ˜ë½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
            });
        }

        subscribePairings();
        subscribeIncoming();

        // ë²„íŠ¼ë“¤
        function getFilters() {
            return {
                year: $("#fYear").value ? Number($("#fYear").value) : null,
                major: $("#fMajor").value.trim() || null,
                gender: $("#fGender").value || null,
                ageMin: $("#fAgeMin").value ? Number($("#fAgeMin").value) : null,
                ageMax: $("#fAgeMax").value ? Number($("#fAgeMax").value) : null,
            };
        }

        startBtn.addEventListener("click", async () => {
            try {
                startBtn.disabled = startBotBtn.disabled = true; cancelBtn.disabled = false;
                setStatus("ëŒ€ê¸°ì—´ ë“±ë¡ ë° ì¡°ê±´ ê²€ìƒ‰ ì¤‘â€¦");
                const pairId = await window.fb.requestMatchingWithFilters(getFilters());
                setStatus("ì œì•ˆì„ ë³´ëƒˆìŠµë‹ˆë‹¤. ìƒëŒ€ ì‘ë‹µì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘â€¦", "ok");
                currentPairId = pairId;
            } catch (e) {
                setStatus("ì‹œì‘ ì‹¤íŒ¨: " + (e.message || e), "err");
                startBtn.disabled = startBotBtn.disabled = false; cancelBtn.disabled = true;
            }
        });

        startBotBtn.addEventListener("click", async () => {
            try {
                botFrame.src = "about:blank"; botFrame.src = "bot.html?headless=1&autostart=1";
                startBtn.disabled = startBotBtn.disabled = true; cancelBtn.disabled = false;
                setStatus("ë´‡ ì¤€ë¹„ ì™„ë£Œ. ëŒ€ê¸°ì—´/ì œì•ˆ ì ˆì°¨ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤â€¦");
                const pairId = await window.fb.requestMatchingWithFilters(getFilters());
                setStatus("ì œì•ˆì„ ë³´ëƒˆìŠµë‹ˆë‹¤. ìƒëŒ€ ì‘ë‹µì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘â€¦", "ok");
                currentPairId = pairId;
            } catch (e) {
                setStatus("ë´‡ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: " + (e.message || e), "err");
                startBtn.disabled = startBotBtn.disabled = false; cancelBtn.disabled = true;
                botFrame.src = "about:blank";
            }
        });

        cancelBtn.addEventListener("click", async () => {
            try { await window.fb.cancelMatching(); setStatus("ëŒ€ê¸°ì—´ì—ì„œ ë‚˜ê°”ìŠµë‹ˆë‹¤."); }
            catch (e) { setStatus("ì·¨ì†Œ ì‹¤íŒ¨: " + (e.message || e), "err"); }
            finally {
                botFrame.src = "about:blank";
                startBtn.disabled = startBotBtn.disabled = false; cancelBtn.disabled = true;
            }
        });

        acceptBtn.addEventListener("click", async () => {
            try {
                await window.fb.respondProposal(currentPairId, true);
                incoming.style.display = "none";
                readyYN.style.display = "block";
                setStatus("ìˆ˜ë½ ì™„ë£Œ. ì±„íŒ… ì‹œì‘(Y/N)ì„ ì„ íƒí•˜ì„¸ìš”.", "ok");
            } catch (e) { setStatus("ìˆ˜ë½ ì‹¤íŒ¨: " + (e.message || e), "err"); }
        });
        declineBtn.addEventListener("click", async () => {
            try {
                await window.fb.respondProposal(currentPairId, false);
                incoming.style.display = "none";
                setStatus("ê±°ì ˆí–ˆìŠµë‹ˆë‹¤. (íŒ¨ë„í‹° ì •ì±…ì´ ì ìš©ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤)", "err");
            } catch (e) { setStatus("ê±°ì ˆ ì‹¤íŒ¨: " + (e.message || e), "err"); }
        });

        yesBtn.addEventListener("click", async () => {
            try { await window.fb.readyForChat(currentPairId, true); setStatus("ìƒëŒ€ í™•ì¸ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘â€¦"); }
            catch (e) { setStatus("ì²˜ë¦¬ ì‹¤íŒ¨: " + (e.message || e), "err"); }
        });
        noBtn.addEventListener("click", async () => {
            try { await window.fb.readyForChat(currentPairId, false); readyYN.style.display = "none"; setStatus("ì±„íŒ… ì‹œì‘ì„ ê±°ì ˆí–ˆìŠµë‹ˆë‹¤.", "err"); }
            catch (e) { setStatus("ì²˜ë¦¬ ì‹¤íŒ¨: " + (e.message || e), "err"); }
        });

        window.addEventListener("beforeunload", async () => {
            try { await window.fb.cancelMatching(); } catch (_) { }
            botFrame.src = "about:blank";
        });
    </script>
</body>
</html>
