<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>í˜¼ë°¥ëŸ¬ Â· ë§¤ì¹­</title>
    <link rel="stylesheet" href="style.css" />
    <script type="module" src="./firebase.js?v=27"></script>
    <style>
        .loading {
            position: relative;
            pointer-events: none;
            opacity: .85
        }

            .loading::after {
                content: " â€¦";
                animation: dots 1.2s steps(3,end) infinite
            }

        @keyframes dots {
            0% {
                content: " ."
            }

            33% {
                content: " .."
            }

            66% {
                content: " ..."
            }

            100% {
                content: " ."
            }
        }

        #filters[aria-disabled="true"] {
            opacity: .55;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="page-header">
            <h1 class="title">ğŸ± í˜¼ë°¥ëŸ¬ Â· ë§¤ì¹­</h1>
            <p class="muted" style="margin-top:4px">â€œí˜¼ë°¥ëŸ¬ ì°¾ê¸°â€ë¥¼ ëˆ„ë¥´ë©´ ëŒ€ê¸°ì—´ì— ë“¤ì–´ê°€ê³ , ë§¤ì¹­ë˜ë©´ â€œìˆ˜ë½/ê±°ì ˆ â†’ ì±„íŒ… ì‹œì‘(Y/n)â€ ì ˆì°¨ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤.</p>
        </header>

        <div class="card" style="max-width:560px">
            <div id="filters" class="row" style="gap:16px; flex-wrap:wrap; margin-bottom:12px">
                <label class="chip"><input id="yearSame" type="checkbox" /> í•™ë²ˆ ê°™ê²Œ</label>
                <label class="chip"><input id="majorSame" type="checkbox" /> í•™ê³¼ ê°™ê²Œ</label>
                <label class="chip"><input id="ageSame" type="checkbox" /> ë‚˜ì´ ê°™ê²Œ</label>
                <label class="chip"><input id="genderSame" type="checkbox" /> ì„±ë³„ ê°™ê²Œ</label>
                <label class="chip"><input id="freeOverlap" type="checkbox" /> ê³µê°• ê²¹ì¹¨ ìš°ì„ </label>
                <label class="chip"><input id="onlineOnly" type="checkbox" /> ë™ì‹œì ‘ì†ë§Œ</label>
            </div>

            <div class="row" style="gap:12px; margin-bottom:8px">
                <button id="startBtn" class="btn outline">í˜¼ë°¥ëŸ¬ ì°¾ê¸°</button>
                <button id="leaveBtn" class="btn outline">ë‚˜ê°€ê¸°</button>
                <button id="reopenBtn" class="btn outline" style="display:none">ì±„íŒ…ë°© ì—´ê¸°</button>
            </div>

            <p id="status" class="muted" style="min-height:20px"></p>

            <div class="row" style="gap:8px; margin-top:8px">
                <a class="btn outline" href="community.html">ì»¤ë®¤ë‹ˆí‹°</a>
                <a class="btn outline" href="profile.html">í”„ë¡œí•„</a>
                <a class="btn outline" href="index.html">í™ˆ</a>
                <a class="btn outline" href="bot.html">ë´‡</a>
            </div>
        </div>
    </div>

    <script type="module">
        const $ = (id) => document.getElementById(id);
        const say = (msg, ok = true) => { const el = $('status'); el.textContent = msg || ''; el.style.color = ok ? 'var(--text-muted,#9fb7d0)' : '#ff6b6b'; };

        async function ensureFbReady(timeoutMs = 8000) {
            if (window.fb) return window.fb;
            const readyP = window.fbReady ?? new Promise((resolve, reject) => {
                const st = Date.now();
                const iv = setInterval(() => {
                    if (window.fb) { clearInterval(iv); resolve(window.fb); }
                    if (Date.now() - st > timeoutMs) { clearInterval(iv); reject(new Error('firebase ë¡œë”ê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ì–´ìš”.')); }
                }, 100);
            });
            const timeoutP = new Promise((_, rej) => setTimeout(() => rej(new Error('firebase ë¡œë”ê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ì–´ìš”.')), timeoutMs));
            return await Promise.race([readyP, timeoutP]);
        }

        const lastRoomId = localStorage.getItem('lastRoomId');
        if (lastRoomId) {
            const b = $('reopenBtn');
            b.style.display = 'inline-block';
            b.addEventListener('click', () => { location.href = `chat.html?room=${encodeURIComponent(lastRoomId)}`; });
        }

        let finding = false;
        let cancelRequested = false;

        const filterIds = ['yearSame', 'majorSame', 'ageSame', 'genderSame', 'freeOverlap', 'onlineOnly'];
        const setFiltersDisabled = (disabled) => {
            const box = $('filters'); box?.setAttribute('aria-disabled', disabled ? 'true' : 'false');
            filterIds.forEach(id => { const el = $(id); if (el) el.disabled = disabled; });
        };
        const setFindingUI = (on) => {
            const startBtn = $('startBtn');
            startBtn.classList.toggle('loading', on);
            startBtn.textContent = on ? 'ë§¤ì¹­ ì¤‘' : 'í˜¼ë°¥ëŸ¬ ì°¾ê¸°';
            startBtn.disabled = on;
            setFiltersDisabled(on);
        };
        const checkCancelled = () => { if (cancelRequested) { say('ëŒ€ê¸°ì—´ì—ì„œ ë‚˜ê°”ì–´ìš”.'); return true; } return false; };

        $('startBtn').addEventListener('click', onStart);
        $('leaveBtn').addEventListener('click', onLeave);

        window.addEventListener('beforeunload', async () => { try { const fb = await ensureFbReady(500); await fb.cancelMatching(); } catch { } });
        document.addEventListener('visibilitychange', async () => {
            if (document.visibilityState === 'hidden') { try { const fb = await ensureFbReady(500); await fb.markLeaving(); } catch { } }
        });

        async function onStart() {
            if (finding) return;
            finding = true; cancelRequested = false; setFindingUI(true); say('ëŒ€ê¸°ì—´ì— ë“±ë¡í–ˆìŠµë‹ˆë‹¤. ë§¤ì¹­ ì¤‘â€¦');
            try {
                const fb = await ensureFbReady();
                if (checkCancelled()) return cleanup();

                const opts = Object.fromEntries(filterIds.map(id => [id, $(id).checked]));
                const { id: roomId } = await fb.startMatching(opts);
                if (checkCancelled()) return cleanup(true, fb);
                say('ë§¤ì¹­ ì¤‘â€¦ (ìƒëŒ€ ìˆ˜ë½ ëŒ€ê¸°)');

                const accepted = await fb.readyToAccept(roomId, 30);
                if (checkCancelled()) return cleanup(true, fb);
                if (!accepted) { say('ìƒëŒ€ê°€ ìˆ˜ë½í•˜ì§€ ì•Šì•˜ì–´ìš”. (íŒ¨ë„í‹° -1ì )', false); await fb.applyPenalty({ kind: 'early_decline' }); return; }

                say('ë§¤ì¹­ ì„±ê³µ! "ì±„íŒ… ì‹œì‘(Y/n)" ë‹¨ê³„ë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤.');
                const yes = window.confirm('ì±„íŒ…ì„ ì‹œì‘ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
                if (checkCancelled()) return cleanup(true, fb);

                if (yes) await fb.startYes(roomId);
                else { await fb.startNo(roomId); say('ì±„íŒ… ì‹œì‘ì„ ê±°ì ˆí–ˆì–´ìš”. (íŒ¨ë„í‹° -1ì )', false); await fb.applyPenalty({ kind: 'start_decline' }); return; }

                say('ë§¤ì¹­ ì¤‘â€¦ (ìƒëŒ€ ì‹œì‘ ì—¬ë¶€ í™•ì¸)');
                const go = await fb.readyToChat(roomId, 30);
                if (checkCancelled()) return cleanup(true, fb);

                if (go) { localStorage.setItem('lastRoomId', roomId); say('ì±„íŒ…ë°©ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤â€¦'); await fb.gotoRoom(roomId); }
                else { say('ìƒëŒ€ê°€ ì±„íŒ… ì‹œì‘ì„ ê±°ì ˆí–ˆì–´ìš”. (íŒ¨ë„í‹° -1ì )', false); await fb.applyPenalty({ kind: 'start_decline' }); }
            } catch (e) { console.error(e); say('ì‹œì‘ ì‹¤íŒ¨: ' + (e?.message || e), false); }
            finally { cleanup(); }
        }

        async function onLeave() {
            cancelRequested = true; finding = false; setFindingUI(false);
            try { const fb = await ensureFbReady(); await fb.cancelMatching(); say('ëŒ€ê¸°ì—´ì—ì„œ ë‚˜ê°”ì–´ìš”.'); }
            catch (e) { console.error(e); say('ë‚˜ê°€ê¸° ì‹¤íŒ¨: ' + (e?.message || e), false); }
        }

        function cleanup(alsoCancel = false, fbInstance = null) {
            if (!cancelRequested) say(''); finding = false; setFindingUI(false);
            if (alsoCancel) (async () => { try { const fb = fbInstance || await ensureFbReady(); await fb.cancelMatching(); } catch { } })();
        }
    </script>
</body>
</html>
