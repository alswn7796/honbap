<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ํ์๊ฐ์ ยท ์ด๋ฉ์ผ ์ธ์ฆ</title>
    <link rel="stylesheet" href="style.css" />
</head>
<body>
    <div class="container">
        <div class="header"><div class="logo">๐</div><h1 class="title">ํผ๋ฐฅ๋ฌ ยท ํ์๊ฐ์</h1></div>

        <div class="card">
            <p class="muted">๊ด์ด๋ ์ด๋ฉ์ผ(@kw.ac.kr)๋ง ํ์ฉ</p>
            <section id="stepEmail">
                <label>ํ๊ต ์ด๋ฉ์ผ</label>
                <div class="row">
                    <input id="email" type="email" placeholder="example@kw.ac.kr" autocomplete="email" />
                    <button id="sendLinkBtn" class="btn" style="width:auto;min-width:160px">์ธ์ฆ ๋ฉ์ผ ๋ณด๋ด๊ธฐ</button>
                </div>
            </section>

            <section id="stepPassword" style="display:none">
                <p id="verifiedEmail" class="muted"></p>
                <label>์ ๋น๋ฐ๋ฒํธ(8์ ์ด์)</label>
                <input id="newPassword" type="password" placeholder="********" />
                <label>์ ๋น๋ฐ๋ฒํธ ํ์ธ</label>
                <input id="confirmPassword" type="password" placeholder="********" />
                <button id="setPassBtn" class="btn">๋น๋ฐ๋ฒํธ ์ค์</button>
            </section>

            <a id="goLogin" class="btn secondary" href="login.html" style="display:none">๋ก๊ทธ์ธ ํ๋ฌ ๊ฐ๊ธฐ</a>
            <p id="msg" class="status"></p>

            <div class="hr"></div>
            <div class="nav">
                <a class="link-btn" href="login.html">๋ก๊ทธ์ธ</a>
                <a class="link-btn" href="index.html">ํ</a>
            </div>
        </div>
    </div>

    <script type="module" src="./firebase.js?v=27"></script>
    <script type="module">
        const $ = (s) => document.querySelector(s);
        const msg = $("#msg"), stepEmail = $("#stepEmail"), stepPassword = $("#stepPassword");
        const verifiedEmail = $("#verifiedEmail"), newPw = $("#newPassword"), confirmPw = $("#confirmPassword"), goLogin = $("#goLogin");
        const clearInvalid = (el) => el && el.classList.remove('invalid');
        const markInvalid = (el) => el && el.classList.add('invalid');
        [newPw, confirmPw].forEach(el => el?.addEventListener('input', () => clearInvalid(el)));

        // ์์: ์กด์ฌํ์ง ์์ผ๋ฉด ์คํ ์ ํจ
        (async () => {
            try {
                const api = await window.fbReady;
                const fn = api?.handleEmailLinkIfPresent;
                if (!fn) return;
                const { consumed, email } = await fn();
                if (consumed) {
                    stepEmail.style.display = "none"; stepPassword.style.display = "block";
                    verifiedEmail.textContent = `์ธ์ฆ ์๋ฃ: ${email}`;
                    msg.className = "status ok"; msg.textContent = "์ธ์ฆ์ด ์๋ฃ๋์์ต๋๋ค. ๋น๋ฐ๋ฒํธ๋ฅผ ์ค์ํ์ธ์.";
                }
            } catch (e) { msg.className = "status err"; msg.textContent = "์ธ์ฆ ์ฒ๋ฆฌ ์ค๋ฅ: " + e.message; }
        })();

        $("#sendLinkBtn")?.addEventListener("click", async () => {
            try { await window.fb.sendEmailLink?.($("#email").value.trim()); msg.className = "status ok"; msg.textContent = "์ธ์ฆ ๋งํฌ๋ฅผ ์์กํ์ต๋๋ค. ๋ฉ์ผํจ์ ํ์ธํ์ธ์."; }
            catch (e) { msg.className = "status err"; msg.textContent = "์์ก ์คํจ: " + (e.message || e); }
        });

        $("#setPassBtn")?.addEventListener("click", async () => {
            try {
                const pw = newPw.value.trim(), pw2 = confirmPw.value.trim();
                if (pw.length < 8) { markInvalid(newPw); msg.className = "status err"; msg.textContent = "๋น๋ฐ๋ฒํธ๋ 8์ ์ด์์ด์ด์ผ ํฉ๋๋ค."; return; }
                if (pw !== pw2) { markInvalid(newPw); markInvalid(confirmPw); msg.className = "status err"; msg.textContent = "๋น๋ฐ๋ฒํธ๊ฐ ์๋ก ์ผ์นํ์ง ์์ต๋๋ค."; return; }
                await window.fb.setPasswordForCurrentUser?.(pw);
                msg.className = "status ok"; msg.textContent = "๋น๋ฐ๋ฒํธ ์ค์ ์๋ฃ! ์๋ ๋ฒํผ์ผ๋ก ๋ก๊ทธ์ธํ์ธ์."; if (goLogin) goLogin.style.display = "block";
            } catch (e) { msg.className = "status err"; msg.textContent = "์ค์ ์คํจ: " + (e.message || e); }
        });
    </script>
</body>
</html>
