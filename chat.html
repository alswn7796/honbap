<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ÌòºÎ∞•Îü¨ ¬∑ Ï±ÑÌåÖ</title>
    <link rel="stylesheet" href="style.css" />
    <style>
        .chat-wrap {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 70vh;
            overflow: auto;
            padding: 8px;
            background: #0e1322;
            border-radius: 12px;
            border: 1px solid #22283a
        }

        .msg {
            padding: 10px 12px;
            border-radius: 12px;
            max-width: 75%
        }

        .me {
            align-self: flex-end;
            background: #1b2438
        }

        .other {
            align-self: flex-start;
            background: #121a2b
        }

        .meta {
            font-size: 11px;
            color: #9aa0a6;
            margin-top: 4px
        }

        .send-row {
            display: flex;
            gap: 8px;
            margin-top: 10px
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="topbar">
            <div class="header" style="margin:0">
                <div class="logo">üçö</div>
                <h1 class="title">Ï±ÑÌåÖÎ∞©</h1>
            </div>
            <a id="leave" class="link-btn" href="match.html">ÎÇòÍ∞ÄÍ∏∞</a>
        </div>

        <div class="card">
            <div id="chat" class="chat-wrap"></div>

            <div class="send-row">
                <input id="text" type="text" placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî" />
                <button id="send" class="btn" style="width:auto;min-width:100px">Ï†ÑÏÜ°</button>
            </div>

            <p id="msg" class="status"></p>
        </div>
    </div>

    <script type="module" src="./firebase.js"></script>
    <script type="module">
  const $ = (s)=>document.querySelector(s);
  const chat = $("#chat");
  const text = $("#text");
  const msg  = $("#msg");

  function getParam(name){
    const u = new URL(location.href);
    return u.searchParams.get(name);
  }
  const roomId = getParam("room");

  try{
    await window.fb.requireAuth();
    if(!roomId) throw new Error("room ÌååÎùºÎØ∏ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.");
    await window.fb.assertRoomMember(roomId);
  }catch(e){
    msg.className="status err"; msg.textContent = "ÏûÖÏû• Ïã§Ìå®: " + e.message;
    setTimeout(()=> location.href="match.html", 800);
  }

  const render = (arr)=>{
    chat.innerHTML = "";
    const me = window.fb.auth.currentUser?.uid;
    arr.forEach(m=>{
      const div = document.createElement("div");
      div.className = "msg " + (m.uid===me? "me":"other");
      div.innerHTML = `
        <div>${escapeHtml(m.text||"")}</div>
        <div class="meta">${m.email? m.email.split("@")[0]:"ÏùµÎ™Ö"}</div>
      `;
      chat.appendChild(div);
    });
    chat.scrollTop = chat.scrollHeight;
  };

  function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }

  // Î©îÏãúÏßÄ Íµ¨ÎèÖ
  const unsub = window.fb.onMessages(roomId, render);

  // Ï†ÑÏÜ°
  $("#send").addEventListener("click", async ()=>{
    try{
      const t = text.value;
      text.value = "";
      await window.fb.sendMessage(roomId, t);
    }catch(e){
      msg.className="status err"; msg.textContent="Ï†ÑÏÜ° Ïã§Ìå®: " + e.message;
    }
  });
  text.addEventListener("keydown", (e)=>{ if(e.key==="Enter") $("#send").click(); });

  // Îñ†ÎÇ† Îïå Íµ¨ÎèÖ Ìï¥Ï†ú
  window.addEventListener("beforeunload", ()=>{ try{unsub&&unsub();}catch(_){} });
    </script>
</body>
</html>
