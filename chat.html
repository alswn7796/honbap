<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ÌòºÎ∞•Îü¨ ¬∑ Ï±ÑÌåÖ</title>
    <link rel="stylesheet" href="style.css" />
    <style>
        .chat-wrap {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 70vh;
            overflow: auto;
            padding: 8px;
            background: #0e1322;
            border-radius: 12px;
            border: 1px solid #22283a
        }

        .msg {
            padding: 10px 12px;
            border-radius: 12px;
            max-width: 75%
        }

        .me {
            align-self: flex-end;
            background: #1b2438
        }

        .other {
            align-self: flex-start;
            background: #121a2b
        }

        .meta {
            font-size: 11px;
            color: #9aa0a6;
            margin-top: 4px
        }

        .send-row {
            display: flex;
            gap: 8px;
            margin-top: 10px
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="topbar">
            <div class="header" style="margin:0">
                <div class="logo">üçö</div>
                <h1 class="title">Ï±ÑÌåÖÎ∞©</h1>
            </div>
            <div class="row" style="gap:8px">
                <!-- üîô Îí§Î°úÍ∞ÄÍ∏∞(Î∞© Ïú†ÏßÄ) / üóë ÏôÑÏ†Ñ ÎÇòÍ∞ÄÍ∏∞(Î∞©ÏóêÏÑú ÌÉàÌá¥) -->
                <button id="backBtn" class="link-btn">Îí§Î°úÍ∞ÄÍ∏∞</button>
                <button id="exitBtn" class="link-btn" style="border-color:#ef4444;color:#ef4444">ÏôÑÏ†Ñ ÎÇòÍ∞ÄÍ∏∞</button>
            </div>
        </div>

        <div class="card">
            <div id="chat" class="chat-wrap"></div>

            <div class="send-row">
                <input id="text" type="text" placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî" />
                <button id="send" class="btn" style="width:auto;min-width:100px">Ï†ÑÏÜ°</button>
            </div>

            <p id="msg" class="status"></p>
        </div>
    </div>

    <script type="module" src="./firebase.js?v=24"></script>

    <script type="module">
        const $ = (s) => document.querySelector(s);
        const chat = $("#chat");
        const text = $("#text");
        const msg = $("#msg");

        function getParam(name) { const u = new URL(location.href); return u.searchParams.get(name); }
        const roomId = getParam("room");

        try {
            await window.fb.requireAuth();
            if (!roomId) throw new Error("room ÌååÎùºÎØ∏ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.");
            await window.fb.assertRoomMember(roomId);
        } catch (e) {
            msg.className = "status err"; msg.textContent = "ÏûÖÏû• Ïã§Ìå®: " + e.message;
            setTimeout(() => location.href = "match.html", 800);
        }

        const esc = (s) => s.replace(/[&<>"']/g, m => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[m]));
        const render = (arr) => {
            chat.innerHTML = "";
            const me = window.fb.auth.currentUser?.uid;
            arr.forEach(m => {
                const div = document.createElement("div");
                div.className = "msg " + (m.uid === me ? "me" : "other");
                div.innerHTML = `<div>${esc(m.text || "")}</div><div class="meta">${m.email ? esc(m.email.split("@")[0]) : "ÏùµÎ™Ö"}</div>`;
                chat.appendChild(div);
            });
            chat.scrollTop = chat.scrollHeight;
        };
        const unsub = window.fb.onMessages(roomId, render);

        $("#send").addEventListener("click", async () => {
            try {
                const t = text.value; text.value = "";
                await window.fb.sendMessage(roomId, t);
            } catch (e) {
                msg.className = "status err"; msg.textContent = "Ï†ÑÏÜ° Ïã§Ìå®: " + e.message;
            }
        });
        text.addEventListener("keydown", (e) => { if (e.key === "Enter") $("#send").click(); });

        // üîô Îí§Î°úÍ∞ÄÍ∏∞: Î∞©ÏùÄ Ïú†ÏßÄ, Î°úÏª¨Ïóê roomId Ï†ÄÏû• ÌõÑ Îß§Ïπ≠ ÌôîÎ©¥ÏúºÎ°ú
        $("#backBtn").addEventListener("click", async () => {
            try {
                localStorage.setItem("lastRoomId", roomId);
                location.href = "match.html";
            } catch { }
        });

        // üóë ÏôÑÏ†Ñ ÎÇòÍ∞ÄÍ∏∞: Î∞©ÏóêÏÑú ÎÇ¥ Î©§Î≤ÑÏã≠ Ï†úÍ±∞, Ï†ÄÏû•Îêú lastRoomId ÏÇ≠Ï†ú
        $("#exitBtn").addEventListener("click", async () => {
            try {
                $("#exitBtn").disabled = true;
                await window.fb.leaveRoom(roomId);
                localStorage.removeItem("lastRoomId");
                location.href = "match.html";
            } catch (e) {
                msg.className = "status err"; msg.textContent = "ÎÇòÍ∞ÄÍ∏∞ Ïã§Ìå®: " + (e.message || e);
            } finally {
                $("#exitBtn").disabled = false;
            }
        });

        // Îñ†ÎÇ† Îïå Íµ¨ÎèÖ Ìï¥Ï†ú
        window.addEventListener("beforeunload", () => { try { unsub && unsub(); } catch { } });
    </script>
</body>
</html>
